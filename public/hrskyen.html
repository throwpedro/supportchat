<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="styles/hrskyen.css">
    <!--     Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <title>Hr-skyen</title>
</head>

<body>
    <div class="pagewrapper">
        <div class="leftchatwrapper col-sm-3">
            <div class="leftchatheader col-sm-12">
                <p class="title">Chat Conversations</p>
                <div class="chatconversations"></div>
            </div>
        </div>
        <div class="mainchatwrapper col-sm-6">
            <div class="mainchatheader">

            </div>
            <div class="mainchatbody">
                <div id="messages">
                </div>
            </div>
            <div class="chatbottom">
                <form action="" class="chatform col-sm-12">
                    <textarea id="m" class="col-sm-12" autocomplete="off" id="m" placeholder="Type here and hit enter to send"></textarea>
                    <button style="visibility: hidden" id="sendButton">send</button>
                </form>
            </div>
        </div>
        <div class="rightchatwrapper col-sm-3">
            <div class="infowrapper col-sm-12">
                <div class="manager ">
                    <p class="managertitle">Manager:</p>
                    <p class="managername panel panel-default">managerexample</p>
                </div>
                <div class="company">
                    <p class="companytitle">Company:</p>
                    <p class="companyname panel panel-default">companyexample</p>
                </div>
            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        //var connectedChats = [];
        var connectionIds = [];
        var conversations = {};
        $(function () {

            var socket = io.connect('http://localhost:3000');
            $('#m').keypress(function (e) {
                if (e.which == 13 && !e.shiftKey) {
                    e.preventDefault();
                    $('#sendButton').trigger('click');
                }
            });

            $('form').submit(function () {
                var txt = $('#m').val();
                if (txt != '') {
                    socket.emit('chat message', txt);
                    $('#messages').append($('<div class="chatmessagesend">').text(txt));
                    $('#messages').scrollTop(100000);
                    $('#m').val('');
                }
                return false;
            });

            socket.on('chat message', function (data) {
                if (!connectionIds.includes(data.id)) {
                    connectionIds.push(data.id);
                    appendchat(data.id);
                    conversations[data.id] = "";
                }
                conversations[data.id] += data.msg + "|||";
                console.log(conversations[data.id]);
                //$('#messages').append($('<div class="chatmessagereceived">').text(data.msg));
                //$('#messages').scrollTop(100000);
            });
        });
        $('.chatconversations').on('click', '.insertonchat', function () {
            $('.mainchatbody').toggle();
            $('.chatbottom').toggle();
            $('#messages').empty();
            console.log(($(this).find('> .customer').text()));
            var cId = $(this).find('> .customer').text();

            var messagesToPrint = conversations[cId].split("|||");
            for (var i = 0; i < messagesToPrint.length; i++) {
                console.log(messagesToPrint[i]);
                if (messagesToPrint[i] != '') {
                    $('#messages').append($('<div class="chatmessagereceived">').text(messagesToPrint[i]));
                }
            }
            //$('#messages').append($('<div class="chatmessagereceived">').text(conversations[cId]));
            /*for(cId in conversations){
>>>>>>> master
                $('#messages').append($('<div class="chatmessagereceived">').text(data.msg));
            }*/
        });
<<<<<<< HEAD
        $('.chatconversations').on('click', '.insertonchat', function () {
            console.log(( $(this).find('> .customer').text()));
            /*if($('.customer').text){
             console.log(socketid);
            }*/
        });



=======
>>>>>>> 6457faa... Clean up a little
        $('.mainchatbody').toggle();
        $('.chatbottom').toggle();

        function appendchat(socketid) {
            var time = new Date($.now());
            $('.chatconversations').append('<div class="insertonchat" style="background-color: green; height: 5em; width: 100%; border-radius: 5px; margin-bottom: 5px;"><p class="customer">' + socketid + '</p><p class="timestamp">' + time + '</p> </div>');
        }
    </script>
</body>

</html>
